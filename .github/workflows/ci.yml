name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend

jobs:
  # ==================== CI é˜¶æ®µï¼šæ„å»ºå’Œæµ‹è¯• ====================
  
  # æ„å»ºå¹¶æµ‹è¯•åç«¯
  build-test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…åç«¯ä¾èµ–
        working-directory: ./backend
        run: npm install

  # æ„å»ºå‰ç«¯
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: npm install

      - name: æ„å»ºå‰ç«¯
        working-directory: ./frontend
        run: npm run build

  # ==================== API é›†æˆæµ‹è¯• ====================
  
  api-test:
    runs-on: ubuntu-latest
    needs: [build-test-backend]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: todo
          POSTGRES_PASSWORD: todo
          POSTGRES_DB: todo_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        working-directory: ./backend
        run: npm install

      - name: å¯åŠ¨åç«¯æœåŠ¡
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_USER: todo
          DB_PASS: todo
          DB_NAME: todo_db
          JWT_SECRET: test-secret-key
          PORT: 3000
        run: |
          node app.js &
          # ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å’ŒæœåŠ¡å¯åŠ¨
          sleep 10
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
          curl -f http://localhost:3000/health || exit 1

      - name: æµ‹è¯• API - æ³¨å†Œ
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:3000/api/register \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","password":"test123"}')
          echo "æ³¨å†Œå“åº”: $RESPONSE"
          echo "$RESPONSE" | grep -q "æ³¨å†ŒæˆåŠŸ" || exit 1

      - name: æµ‹è¯• API - ç™»å½•
        id: login
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:3000/api/login \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","password":"test123"}')
          echo "ç™»å½•å“åº”: $RESPONSE"
          TOKEN=$(echo "$RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          [ -n "$TOKEN" ] || exit 1

      - name: æµ‹è¯• API - åˆ›å»º Todo
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:3000/api/todos \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}" \
            -d '{"content":"æµ‹è¯• Todo é¡¹ç›®"}')
          echo "åˆ›å»º Todo å“åº”: $RESPONSE"
          echo "$RESPONSE" | grep -q "id" || exit 1

      - name: æµ‹è¯• API - è·å– Todo åˆ—è¡¨
        run: |
          RESPONSE=$(curl -s http://localhost:3000/api/todos \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}")
          echo "Todo åˆ—è¡¨å“åº”: $RESPONSE"
          echo "$RESPONSE" | grep -q "æµ‹è¯• Todo é¡¹ç›®" || exit 1

  # ==================== CD é˜¶æ®µï¼šDocker é•œåƒæ„å»º ====================
  
  docker-build-push:
    needs: [build-frontend, api-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æå– Docker å…ƒæ•°æ® - åç«¯
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: æå– Docker å…ƒæ•°æ® - å‰ç«¯
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================== å¯é€‰ï¼šéƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨ ====================
  
  deploy:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main'
    steps:
      - name: éƒ¨ç½²æç¤º
        run: |
          echo "âœ… Docker é•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ° GHCR"
          echo "ğŸ“¦ åç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}"
          echo "ğŸ“¦ å‰ç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}"
          echo ""
          echo "ğŸ’¡ è¦å¯ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½®ï¼š"
          echo "   - DEPLOY_HOST: æœåŠ¡å™¨åœ°å€"
          echo "   - DEPLOY_USER: SSH ç”¨æˆ·å"
          echo "   - DEPLOY_KEY: SSH ç§é’¥"
          echo "   - DEPLOY_PATH: éƒ¨ç½²è·¯å¾„"
